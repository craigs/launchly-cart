<html>
<head>
	<title>Launch.ly Event Bubbling Sample</title>
	<script src="../libs/jquery-loader.js"></script>
</head>
<body>

<button class="empty-cart">Empty Cart</button>


<script>
cart = {

	/* List of methods                                                                  */
	/* ---------------                                                                  */
	/* add                                                                              */
	/* dec                                                                              */
	/* empty                                                                            */
	/* get */
	/* update */
	/* inc                                                                              */
	/* remove                                                                           */
	/* set                                                                              */
	/* pay                                                                              */
	/* payment_type_from_number                                                         */
	/*                                                                                  */
	
	/* List of events                                                                   */
	/* --------------                                                                   */
	/* cart.changed           the contents of the shopping cart has changed             */
	/* cart.recieved          a new cart has been downloaded                            */
	/* cart.payment.success   the order was successfully paid for                       */
	/* cart.payment.failure   the payment was rejected and the order was not submitted  */
	/*                                                                                  */
	/*                                                                                  */

	dec: function(element) {
		
		$.post("/{{ locale }}/__/cart/inc.json", cart.variant_data, function(data) {
			$(cart).trigger('cart.changed', [data]);
		});
		
	},

	/* empty the shopping cart */
	empty: function() {

		$.get("/{{ locale }}/__/cart/empty.json", { 'authenticity_token': rails_authenticity_token }, function(data) {
			$(cart).trigger('cart.changed', [data]);
		});

	},
	
	get: function(element) {
		$.get("/{{ locale }}/__/cart.json", { authenticity_token: rails_authenticity_token }, function(data) { 
			$(cart).trigger('cart.recieved', [data]);
		});
	},
	
	inc: function(element) {
		$.post("/{{ locale }}/__/cart/inc.json", cart.variant_data, function(data) {
			$(cart).trigger('cart.changed', [data]);
		});
	},

	/* add a variant to the shopping cart */
	add: function(element) {
		$.post("/{{ locale }}/__/cart/add.json", cart.variant_data, function(data) {
			$(cart).trigger('cart.changed', [data]);
		});
	},

	set: function(element) {
		$.post("/{{ locale }}/__/cart/set.json", cart.variant_data, function(data) {
			$(cart).trigger('cart.changed', [data]);
		});
	},
	
	item_id: function(element) {
		return element.data('item')
	},
		
	variant_id: function(item_id) {

		v_id = $('#v_' + i_id + ' :selected').val();

		if (typeof v_id == "undefined") {
			v_id = $('#v_' + i_id).val();
		}
		
		return v_id;
	},
	
	qty: function(item_id) {
		return $('#q_' + item_id).val();
	},
	
	variant_data: function() {

		i_id = cart.item_id(element);
		v_id = cart.variant_id(i_id);
		qty = cart.qty(i_id);
		
		data = {
			'authenticity_token': rails_authenticity_token,
			'v': []
		};

		data['v'].push(v_id);
		data['q_' + v_id] = qty;
		
		return data
	},
		

	/* pay for an order */
	pay: function() {
		
		$.ajax({
			type: "POST",
			url: "{{ '/__/pay/cart.json' | secure_url }}",
			data: {
				'_launch_ly_session': $('#session_id').val(),
				'reference': $('#cart_reference').val(),
				'first_name': $('#card_first_name').val(),
				'last_name': $('#card_last_name').val(),
				'card_number': $('#card_number').val(),
				'payment_type': $('#payment_type').val(),
				'expires_month': $('#card_expires_month').val(),
				'expires_year': $('#card_expires_year').val(),
				'card_verification': $('#card_verification').val()			
			},
			success: function(data) { 
				$(cart).trigger('cart.payment.success', [data]);
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
				response = $.parseJSON(XMLHttpRequest.responseText);
				$(cart).trigger('cart.payment.failed', [response]);
			}
		});
		
	},
	
	/* extract the payment type from the credit card number */
	payment_type_from_number: function(card_number) {	

		card_type = '';
		card_number = card_number.replace(/[^\d]/g,'');

		// see http://en.wikipedia.org/wiki/List_of_Bank_Identification_Numbers
		if (card_number.match(/^37\d{13}/)) { card_type = 'american_express'; }
		if (card_number.match(/^4\d{15}/) || card_number.match(/^4\d{12}/)) { card_type = 'visa'; }
		if (card_number.match(/^5[1-5]\d{14}$/)) { card_type = 'master'; }
		if (card_number.match(/^36\d{11}/)) { card_type = 'diners_club'; }	

		return card_type;	
	}	

	remove: function(element) {
	},

	set: function(element) {
	},
	
	update: function(element) {
	},	

};

/*  */

$(document).ready(function() {
	
	// Listen for event
	$(cart).on('cart.changed', function(event, data) {
		alert('Shopping cart has been changed. ' + data);
		update_cart(data);
	});

	$(document).on('click', '.empty-cart', function(event) {
		cart.empty();	
	});
	
});
</script>
</body>
</html>